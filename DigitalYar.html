<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>دیجیتال‌یار - آزمون‌ساز هوشمند</title>
    <link
      href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- اضافه کردن PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
    <style>
      /* فونت BNaznin */
      @font-face {
        font-family: "BNaznin";
        src: url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.eot");
        src: url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.eot?#iefix")
            format("embedded-opentype"),
          url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.woff2")
            format("woff2"),
          url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.woff")
            format("woff"),
          url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.ttf")
            format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      /* تم اقیانوس (پیش‌فرض) */
      :root {
        --primary-color: #006994;
        --primary-light: #0088b2;
        --primary-dark: #005276;
        --secondary-color: #00b4d8;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --water-color: #e0f7ff;
        --water-light: #f0fbff;
        --water-dark: #b3e5fc;
        --text-color: #0a3d62;
        --text-muted: #4a6b8a;
        --border-color: #81d4fa;
        --card-bg: rgba(255, 255, 255, 0.92);
        --card-hover: rgba(255, 255, 255, 0.97);
        --header-bg: rgba(224, 247, 255, 0.92);
        --shadow: 0 8px 32px rgba(0, 105, 148, 0.18);
        --shadow-light: 0 4px 16px rgba(0, 105, 148, 0.12);
        --gradient-primary: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        --gradient-water: linear-gradient(
          135deg,
          var(--water-light),
          var(--water-color)
        );
        --gradient-glass: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.75),
          rgba(255, 255, 255, 0.45)
        );
        --border-radius: 12px;
        --border-radius-sm: 8px;
        --border-radius-lg: 20px;
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --transition-slow: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        --font-family: "BNaznin", Vazirmatn, sans-serif;
      }

      /* تم ساحل (روشن) - بهبود یافته */
      [data-theme="beach"] {
        --primary-color: #ff7e5f;
        --primary-light: #ff9e80;
        --primary-dark: #e85c40;
        --secondary-color: #feb47b;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --water-color: #fff5e6;
        --water-light: #fffaf0;
        --water-dark: #ffe4c4;
        --text-color: #5d4037;
        --text-muted: #8d6e63;
        --border-color: #ffccbc;
        --card-bg: rgba(255, 255, 255, 0.92);
        --card-hover: rgba(255, 255, 255, 0.97);
        --header-bg: rgba(255, 245, 230, 0.92);
        --shadow: 0 8px 32px rgba(255, 126, 95, 0.2);
        --shadow-light: 0 4px 16px rgba(255, 126, 95, 0.15);
        --gradient-primary: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        --gradient-water: linear-gradient(
          135deg,
          var(--water-light),
          var(--water-color)
        );
        --gradient-glass: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.75),
          rgba(255, 255, 255, 0.45)
        );
      }

      /* تم کهکشان (تاریک) - بهبود یافته */
      [data-theme="galaxy"] {
        --primary-color: #8a2be2;
        --primary-light: #9370db;
        --primary-dark: #4b0082;
        --secondary-color: #00bfff;
        --success-color: #00fa9a;
        --warning-color: #ffd700;
        --danger-color: #ff4500;
        --water-color: #0c0032;
        --water-light: #190061;
        --water-dark: #04000f;
        --text-color: #e6e6fa;
        --text-muted: #a9a9a9;
        --border-color: #483d8b;
        --card-bg: rgba(25, 0, 97, 0.88);
        --card-hover: rgba(40, 0, 130, 0.92);
        --header-bg: rgba(12, 0, 50, 0.92);
        --shadow: 0 8px 32px rgba(138, 43, 226, 0.25);
        --shadow-light: 0 4px 16px rgba(138, 43, 226, 0.2);
        --gradient-primary: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        --gradient-water: linear-gradient(
          135deg,
          var(--water-light),
          var(--water-color)
        );
        --gradient-glass: linear-gradient(
          135deg,
          rgba(25, 0, 97, 0.75),
          rgba(25, 0, 97, 0.45)
        );
      }

      /* تم معدن زغال سنگ (تاریک) - بهبود یافته */
      [data-theme="coal-mine"] {
        --primary-color: #4ecdc4;
        --primary-light: #68d8d6;
        --primary-dark: #2a9d8f;
        --secondary-color: #f9c74f;
        --success-color: #90be6d;
        --warning-color: #f8961e;
        --danger-color: #f94144;
        --water-color: #1a1a1d;
        --water-light: #2d2d30;
        --water-dark: #0d0d0d;
        --text-color: #edf2f4;
        --text-muted: #8d99ae;
        --border-color: #4a4e69;
        --card-bg: rgba(45, 45, 48, 0.88);
        --card-hover: rgba(55, 55, 58, 0.92);
        --header-bg: rgba(26, 26, 29, 0.92);
        --shadow: 0 8px 32px rgba(78, 205, 196, 0.25);
        --shadow-light: 0 4px 16px rgba(78, 205, 196, 0.2);
        --gradient-primary: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        --gradient-water: linear-gradient(
          135deg,
          var(--water-light),
          var(--water-color)
        );
        --gradient-glass: linear-gradient(
          135deg,
          rgba(45, 45, 48, 0.75),
          rgba(45, 45, 48, 0.45)
        );
      }

      /* ریست استایل‌ها */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: var(--font-family);
      }

      body {
        background: var(--gradient-water);
        color: var(--text-color);
        line-height: 1.6;
        transition: var(--transition-slow);
        min-height: 100vh;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
        backdrop-filter: blur(10px);
        position: relative;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        transform: translateZ(0);
        margin-top: 20px;
        margin-bottom: 20px;
      }

      /* هدر */
      .header {
        background: var(--header-bg);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
        box-shadow: var(--shadow-light);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .logo i {
        font-size: 2.2rem;
        color: var(--primary-color);
        transition: var(--transition);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .logo:hover i {
        transform: rotate(-15deg);
      }

      /* کنترل‌های هدر */
      .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .theme-selector {
        display: flex;
        gap: 8px;
        background: var(--gradient-glass);
        padding: 8px;
        border-radius: var(--border-radius);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-light);
      }

      .theme-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .theme-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: var(--transition);
        border-radius: 50%;
      }

      .theme-btn.active,
      .theme-btn:hover {
        color: white;
        transform: translateY(-3px);
        box-shadow: var(--shadow-light);
      }

      .theme-btn.active::before,
      .theme-btn:hover::before {
        opacity: 1;
      }

      .theme-btn i {
        position: relative;
        z-index: 1;
      }

      .main-content {
        padding: 30px;
      }

      .page {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
      }

      .page.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }

      .form-container {
        background: var(--card-bg);
        padding: 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
        position: relative;
      }

      .form-container h2 {
        color: var(--primary-color);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .form-container p {
        color: var(--text-muted);
        margin-bottom: 25px;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--text-color);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        transition: var(--transition);
        background-color: var(--card-bg);
        color: var(--text-color);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 105, 148, 0.3);
      }

      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }

      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
      }

      .btn-primary {
        background: var(--gradient-primary);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(90deg, #6c757d 0%, #495057 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(
          90deg,
          var(--success-color) 0%,
          #27ae60 100%
        );
        color: white;
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(-1px);
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: var(--text-muted);
        border-top: 1px solid var(--border-color);
        margin-top: 30px;
        font-size: 0.9rem;
      }

      .input-group {
        margin-bottom: 20px;
        position: relative;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--primary-color);
      }

      .input-group textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-family: "BNaznin", "Vazirmatn", monospace;
        resize: vertical;
        min-height: 120px;
        background: var(--card-bg);
        color: var(--text-color);
      }

      .input-group textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 105, 148, 0.3);
      }

      /* استایل‌های جدید برای آپلود فایل */
      .file-upload-container {
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        background: rgba(0, 105, 148, 0.05);
      }

      .file-upload-container:hover {
        border-color: var(--primary-color);
        background: rgba(0, 105, 148, 0.1);
      }

      .file-upload-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 15px;
      }

      .file-upload-text h3 {
        color: var(--primary-color);
        margin-bottom: 10px;
      }

      .file-upload-text p {
        color: var(--text-muted);
        margin-bottom: 15px;
      }

      .file-formats {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .format-badge {
        padding: 5px 10px;
        background: var(--primary-light);
        color: white;
        border-radius: var(--border-radius-sm);
        font-size: 0.8rem;
      }

      .upload-preview {
        margin-top: 20px;
        max-width: 100%;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        display: none;
      }

      /* استایل‌های جدید برای کارت‌های گزینه */
      .options-card-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .option-card {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
      }

      .option-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-light);
        border-color: var(--primary-light);
      }

      .option-card.selected {
        border-color: var(--primary-color);
        background: rgba(0, 105, 148, 0.1);
        transform: translateY(-5px);
        box-shadow: var(--shadow-light);
      }

      .option-card h3 {
        color: var(--primary-color);
        margin-bottom: 5px;
      }

      .option-card p {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      /* استایل‌های جدید برای تایمر */
      .timer-input-simple {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .timer-input-simple input {
        max-width: 120px;
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .timer-input-simple span {
        font-weight: bold;
        color: var(--primary-color);
      }

      /* استایل‌های جدید برای پرامپت‌ها */
      .prompt-section {
        background: rgba(0, 105, 148, 0.05);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
      }

      .prompt-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .prompt-btn {
        padding: 10px 15px;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
      }

      .prompt-btn:hover {
        background: var(--primary-color);
        transform: translateY(-2px);
      }

      .copy-btn {
        position: absolute;
        left: 15px;
        top: 40px;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        padding: 8px 12px;
        cursor: pointer;
        transition: var(--transition);
      }

      .copy-btn:hover {
        background: var(--primary-color);
      }

      .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
      }

      /* استایل‌های صفحه آزمون */
      .exam-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .exam-title {
        font-size: 1.5rem;
        color: var(--primary-color);
      }

      .timer-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .timer {
        font-size: 1.8rem;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        background: rgba(0, 105, 148, 0.1);
        color: var(--primary-color);
        position: relative;
        overflow: hidden;
      }

      .timer::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transform: translateX(-100%);
        transition: transform 0.5s ease;
      }

      .timer:hover::before {
        transform: translateX(100%);
      }

      .timer.hidden {
        filter: blur(5px);
      }

      .toggle-timer {
        padding: 5px 10px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: var(--card-bg);
        color: var(--text-color);
        cursor: pointer;
      }

      .filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-btn {
        padding: 8px 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: var(--card-bg);
        color: var(--text-color);
        cursor: pointer;
        transition: var(--transition);
      }

      .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* نوار وضعیت سوالات */
      .progress-bar {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .progress-item {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--border-color);
        color: var(--text-muted);
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
      }

      .progress-item.active {
        background: var(--primary-color);
        color: white;
        transform: scale(1.1);
      }

      .progress-item.answered {
        background: var(--success-color);
        color: white;
      }

      .progress-item.current {
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      .questions-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .question-card {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 15px;
        background: var(--card-bg);
        transition: var(--transition);
        position: relative;
        margin-bottom: 20px;
        box-shadow: var(--shadow-light);
      }

      .question-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .question-number {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .question-image {
        width: 100%;
        margin-bottom: 15px;
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-light);
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .question-image:hover {
        transform: scale(1.02);
      }

      .options-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .option-item {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
      }

      .option-item:hover {
        background: rgba(0, 105, 148, 0.1);
      }

      .option-item.selected {
        background: rgba(46, 204, 113, 0.2);
        border-color: var(--success-color);
      }

      .option-marker {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .option-item.selected .option-marker {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
      }

      .exam-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
      }

      /* صفحه‌بندی بهبود یافته */
      .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
      }

      .page-btn {
        padding: 8px 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: var(--card-bg);
        color: var(--text-color);
        cursor: pointer;
        transition: var(--transition);
      }

      .page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .page-btn:hover:not(.active) {
        background: rgba(0, 105, 148, 0.1);
      }

      /* مودال‌های جدید */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      .modal.active {
        display: flex;
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: var(--shadow);
        animation: scaleIn 0.3s ease;
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
      }

      /* راهنمای آزمون */
      .guide-container {
        background: rgba(0, 105, 148, 0.05);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 25px;
        border-left: 5px solid var(--primary-color);
      }

      .guide-container h3 {
        color: var(--primary-color);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .guide-steps {
        margin-right: 20px;
      }

      .guide-steps li {
        margin-bottom: 10px;
        color: var(--text-color);
      }

      .warning-box {
        background: rgba(243, 156, 18, 0.1);
        border: 1px solid var(--warning-color);
        border-radius: var(--border-radius-sm);
        padding: 15px;
        margin-top: 15px;
      }

      .warning-box h4 {
        color: var(--warning-color);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* صفحه نتایج */
      .result-page {
        text-align: center;
        padding: 40px 20px;
      }

      .result-page h2 {
        color: var(--primary-color);
        margin-bottom: 20px;
      }

      .result-page p {
        color: var(--text-muted);
        margin-bottom: 30px;
      }

      /* استایل‌های جدید برای کارت‌های سوال بهبود یافته */
      .question-card-improved {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        background: var(--card-bg);
        transition: var(--transition);
        position: relative;
        margin-bottom: 20px;
        box-shadow: var(--shadow-light);
      }

      .question-card-improved:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .question-title {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1.2rem;
      }

      .question-options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 15px;
      }

      .question-option {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .question-option:hover {
        background: rgba(0, 105, 148, 0.1);
      }

      .question-option.selected {
        background: rgba(46, 204, 113, 0.2);
        border-color: var(--success-color);
        color: var(--success-color);
      }

      /* استایل‌های جدید برای راهنمای جامع */
      .comprehensive-guide {
        background: rgba(0, 105, 148, 0.05);
        border-radius: var(--border-radius);
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
      }

      .comprehensive-guide h3 {
        color: var(--primary-color);
        margin-bottom: 20px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .guide-steps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .guide-step-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        text-align: center;
        box-shadow: var(--shadow-light);
        transition: var(--transition);
      }

      .guide-step-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow);
      }

      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .step-title {
        color: var(--primary-color);
        margin-bottom: 10px;
        font-weight: bold;
      }

      .step-description {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      /* استایل‌های جدید برای صفحه نتایج بهبود یافته */
      .result-container {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-light);
      }

      .result-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .result-score {
        font-size: 3rem;
        font-weight: bold;
        color: var(--primary-color);
        margin: 20px 0;
      }

      .result-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .result-detail-card {
        background: rgba(0, 105, 148, 0.05);
        border-radius: var(--border-radius);
        padding: 20px;
        text-align: center;
      }

      .result-detail-card h4 {
        color: var(--primary-color);
        margin-bottom: 10px;
      }

      .result-detail-card p {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--text-color);
      }

      /* انیمیشن‌ها */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      /* استایل‌های جدید برای زوم تصاویر */
      /* مودال زوم تصویر */
      .image-zoom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10001;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        backdrop-filter: blur(5px);
        cursor: zoom-out;
      }

      .image-zoom-modal.active {
        opacity: 1;
        visibility: visible;
      }

      .zoomed-image-container {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .zoomed-image {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: var(--border-radius);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        transform: scale(0.95);
        transition: transform 0.3s ease;
        cursor: default;
      }

      .image-zoom-modal.active .zoomed-image {
        transform: scale(1);
      }

      .close-zoom {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 40px;
        cursor: pointer;
        z-index: 10002;
        background: rgba(0, 0, 0, 0.5);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }

      .close-zoom:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
      }

      /* اضافه کردن این استایل‌ها به بخش CSS */
      .timer-input-container {
        margin-bottom: 20px;
      }

      .timer-input-stretched {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      .stretched-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        transition: var(--transition);
        background-color: var(--card-bg);
        color: var(--text-color);
        text-align: center;
      }

      .minute-label {
        font-weight: bold;
        color: var(--primary-color);
        min-width: 60px;
      }

      /* جلوگیری از اسکرول هنگام نمایش مودال */
      body.modal-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      /* استایل‌های جدید برای گزینه‌های مربعی */
      .options-container-horizontal {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .option-square {
        width: 60px;
        height: 60px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        background: var(--card-bg);
        font-weight: bold;
        font-size: 1.2rem;
      }

      .option-square:hover {
        background: rgba(0, 105, 148, 0.1);
        transform: translateY(-3px);
      }

      .option-square.selected {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
        transform: scale(1.05);
      }

      .option-number {
        color: var(--text-color);
      }

      .option-square.selected .option-number {
        color: white;
      }

      /* بهبود ظاهر سوالات */
      .question-card-improved {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 25px;
        background: var(--card-bg);
        transition: var(--transition);
        position: relative;
        margin-bottom: 25px;
        box-shadow: var(--shadow-light);
      }

      .question-card-improved:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .question-title {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1.3rem;
        font-family: "BNaznin", Vazirmatn, sans-serif;
      }

      .question-image {
        width: 100%;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        margin-bottom: 20px;
        max-height: 300px;
        object-fit: contain;
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 20px;
        }

        .exam-header {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .timer-container {
          margin-bottom: 15px;
        }

        .filters {
          flex-wrap: wrap;
        }

        .options-container {
          flex-direction: column;
        }

        .option-item {
          min-width: auto;
        }

        .modal-buttons {
          flex-direction: column;
        }

        .progress-item {
          width: 30px;
          height: 30px;
          font-size: 0.9rem;
        }

        .options-card-container {
          grid-template-columns: 1fr 1fr;
        }

        .prompt-buttons {
          flex-direction: column;
        }

        .form-actions {
          flex-direction: column;
        }

        .header {
          flex-direction: column;
          gap: 15px;
        }

        .question-options-grid {
          grid-template-columns: 1fr;
        }

        .guide-steps-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .options-card-container {
          grid-template-columns: 1fr;
        }

        .theme-selector {
          flex-wrap: wrap;
          justify-content: center;
        }

        .result-details {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body data-theme="ocean">
    <div class="container">
      <!-- هدر جدید -->
      <div class="header">
        <div class="logo">
          <i class="fas fa-graduation-cap"></i>
          <span>دیجیتال‌یار</span>
        </div>

        <div class="header-controls">
          <div class="theme-selector">
            <button
              class="theme-btn active"
              data-theme="ocean"
              title="تم اقیانوس"
            >
              <i class="fas fa-water"></i>
            </button>
            <button class="theme-btn" data-theme="beach" title="تم ساحل">
              <i class="fas fa-umbrella-beach"></i>
            </button>
            <button class="theme-btn" data-theme="galaxy" title="تم کهکشان">
              <i class="fas fa-gem"></i>
            </button>
            <button
              class="theme-btn"
              data-theme="coal-mine"
              title="تم معدن زغال سنگ"
            >
              <i class="fas fa-mountain"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="main-content">
        <!-- صفحه آماده‌سازی آزمون دستی -->
        <div id="manual-exam" class="page active">
          <div class="form-container">
            <h2><i class="fas fa-cogs"></i> تنظیمات آزمون</h2>

            <!-- راهنمای جامع استفاده -->
            <div class="comprehensive-guide">
              <h3><i class="fas fa-info-circle"></i> روند کار برنامه</h3>
              <p>
                برای استفاده از دیجیتال‌یار، لطفاً مراحل زیر را به دقت دنبال
                کنید:
              </p>

              <div class="guide-steps-grid">
                <div class="guide-step-card">
                  <div class="step-number">1</div>
                  <div class="step-title">آپلود فایل سوالات</div>
                  <div class="step-description">
                    فایل سوالات یا عکس سوال خود را در برنامه آپلود کنید.
                  </div>
                </div>

                <div class="guide-step-card">
                  <div class="step-number">2</div>
                  <div class="step-title">ارسال به هوش مصنوعی</div>
                  <div class="step-description">
                    فایل سوالات را به همراه پرامپت JSON برای هوش مصنوعی ارسال
                    کنید.
                  </div>
                </div>

                <div class="guide-step-card">
                  <div class="step-number">3</div>
                  <div class="step-title">دریافت کد</div>
                  <div class="step-description">
                    کد تولید شده توسط هوش مصنوعی را در برنامه وارد کنید.
                  </div>
                </div>

                <div class="guide-step-card">
                  <div class="step-number">4</div>
                  <div class="step-title">ساخت آزمون</div>
                  <div class="step-description">
                    بر روی گزینه «ساخت آزمون» کلیک کنید تا فرآیند ایجاد آزمون
                    آغاز شود.
                  </div>
                </div>

                <div class="guide-step-card">
                  <div class="step-number">5</div>
                  <div class="step-title">کلید آزمون</div>
                  <div class="step-description">
                    بعد از اتمام آزمون وارد صفحه کلید آزمون می‌شوید. پرامپت کلید
                    آزمون را کپی کرده و برای هوش مصنوعی ارسال کنید.
                  </div>
                </div>

                <div class="guide-step-card">
                  <div class="step-number">6</div>
                  <div class="step-title">مشاهده کارنامه</div>
                  <div class="step-description">
                    کلید آزمون دریافت شده را وارد کرده و کارنامه خود را مشاهده
                    کنید.
                  </div>
                </div>
              </div>

              <div class="warning-box">
                <h4><i class="fas fa-exclamation-triangle"></i> توجه مهم</h4>
                <p>
                  هرگونه اطلاعات اضافی به جای کدها می‌تواند موجب اختلال در
                  فرآیند ساخت آزمون و صدور کارنامه شود.
                </p>
              </div>
            </div>

            <!-- آپلود فایل -->
            <div class="form-group">
              <label>آپلود فایل سوالات:</label>
              <div
                class="file-upload-container"
                onclick="document.getElementById('file-upload').click()"
              >
                <div class="file-upload-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="file-upload-text">
                  <h3>فایل سوالات خود را اینجا رها کنید یا کلیک کنید</h3>
                  <p>می‌توانید فایل PDF یا تصاویر سوالات را آپلود کنید</p>
                </div>
                <input
                  type="file"
                  id="file-upload"
                  accept=".pdf,.png,.jpg,.jpeg"
                  style="display: none"
                  onchange="handleFileUpload(this)"
                />
                <div class="file-formats">
                  <span class="format-badge">PDF</span>
                  <span class="format-badge">PNG</span>
                  <span class="format-badge">JPG</span>
                  <span class="format-badge">JPEG</span>
                </div>
              </div>
              <img
                id="upload-preview"
                class="upload-preview"
                alt="پیش‌نمایش فایل"
              />
            </div>

            <!-- تعداد گزینه‌های هر سوال -->
            <div class="form-group">
              <label>تعداد گزینه‌های هر سوال:</label>
              <div class="options-card-container">
                <div
                  class="option-card"
                  data-options="2"
                  onclick="selectOptionCard(this)"
                >
                  <h3>۲ گزینه‌ای</h3>
                  <p>صحیح/غلط یا دو گزینه‌ای</p>
                </div>
                <div
                  class="option-card"
                  data-options="3"
                  onclick="selectOptionCard(this)"
                >
                  <h3>۳ گزینه‌ای</h3>
                  <p>سوالات سه گزینه‌ای</p>
                </div>
                <div
                  class="option-card selected"
                  data-options="4"
                  onclick="selectOptionCard(this)"
                >
                  <h3>۴ گزینه‌ای</h3>
                  <p>سوالات استاندارد</p>
                </div>
                <div
                  class="option-card"
                  data-options="5"
                  onclick="selectOptionCard(this)"
                >
                  <h3>۵ گزینه‌ای</h3>
                  <p>سوالات پنج گزینه‌ای</p>
                </div>
              </div>
            </div>

            <!-- جایگزینی بخش تایمر با این کد -->
            <div class="timer-input-container">
              <label>زمان آزمون (دقیقه):</label>
              <div class="timer-input-stretched">
                <input
                  type="number"
                  id="timer-input"
                  min="1"
                  value="120"
                  class="stretched-input"
                />
                <span class="minute-label">دقیقه</span>
              </div>
            </div>

            <!-- پرامپت‌های هوش مصنوعی -->
            <div class="prompt-section">
              <h3><i class="fas fa-robot"></i> پرامپت‌های هوش مصنوعی</h3>
              <p>
                برای دریافت کدهای لازم، این پرامپت‌ها را برای هوش مصنوعی کپی
                کنید:
              </p>

              <div class="prompt-buttons">
                <button class="prompt-btn" onclick="copyPrompt('json')">
                  <i class="fas fa-copy"></i> کپی پرامپت JSON برش
                </button>
              </div>
            </div>

            <!-- کد JSON -->
            <div class="input-group">
              <label for="json-code">کد JSON برش سوالات:</label>
              <div class="copy-btn" onclick="copyPrompt('json')">
                <i class="fas fa-copy"></i>
              </div>
              <textarea
                id="json-code"
                placeholder='برای دریافت پرامپت، روی دکمه "کپی پرامپت JSON برش" کلیک کنید'
              ></textarea>
            </div>

            <!-- دکمه‌های اقدام -->
            <div class="form-actions">
              <button class="btn btn-primary" onclick="createExam()">
                <i class="fas fa-play"></i> ساخت آزمون
              </button>

              <button
                class="btn btn-secondary"
                onclick="window.location.href='index.html'"
              >
                <i class="fas fa-arrow-right"></i> بازگشت
              </button>
            </div>
          </div>
        </div>

        <!-- صفحه آزمون فعال -->
        <div id="manual-exam-page" class="page">
          <div class="form-container">
            <div class="exam-header">
              <h3 class="exam-title" id="exam-name">آزمون دستی</h3>
              <div class="timer-container">
                <div class="timer" id="exam-timer">120:00</div>
                <button
                  class="btn btn-primary"
                  id="start-exam-btn"
                  onclick="startExam()"
                >
                  <i class="fas fa-play"></i> شروع آزمون
                </button>
                <button
                  class="toggle-timer"
                  id="hide-timer-btn"
                  onclick="toggleTimerVisibility()"
                >
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>

            <div class="filters">
              <button
                class="filter-btn active"
                onclick="filterQuestions('all')"
              >
                همه سوالات
              </button>
              <button
                class="filter-btn"
                onclick="filterQuestions('not-answered')"
              >
                پاسخ داده نشده
              </button>
              <button class="filter-btn" onclick="filterQuestions('answered')">
                پاسخ داده شده
              </button>
            </div>

            <!-- نوار وضعیت سوالات -->
            <div class="progress-bar" id="progress-bar">
              <!-- نوار وضعیت اینجا ساخته می‌شود -->
            </div>

            <div class="questions-container" id="questions-container">
              <!-- سوالات اینجا نمایش داده می‌شوند -->
            </div>

            <!-- صفحه‌بندی -->
            <div class="pagination" id="pagination">
              <!-- دکمه‌های صفحه‌بندی اینجا ساخته می‌شوند -->
            </div>

            <div class="exam-actions">
              <button class="btn btn-success" onclick="confirmFinishExam()">
                <i class="fas fa-flag-checkered"></i> پایان آزمون
              </button>
              <button
                class="btn btn-secondary"
                onclick="showPage('manual-exam')"
              >
                <i class="fas fa-arrow-right"></i> بازگشت
              </button>
            </div>
          </div>
        </div>

        <!-- صفحه نتایج - بخش تغییر یافته -->
        <div id="result-page" class="page">
          <div class="form-container">
            <div class="result-page">
              <h2><i class="fas fa-chart-line"></i> نتایج آزمون</h2>

              <!-- نمایش آمار آزمون -->
              <div class="result-container" id="exam-stats">
                <div class="result-header">
                  <h3>خلاصه عملکرد شما</h3>
                  <div class="result-score" id="answered-count">0</div>
                  <p>سوال پاسخ داده شده</p>
                </div>

                <div class="result-details">
                  <div class="result-detail-card">
                    <h4>کل سوالات</h4>
                    <p id="total-questions">0</p>
                  </div>
                  <div class="result-detail-card">
                    <h4>سوالات بی‌پاسخ</h4>
                    <p id="unanswered-count">0</p>
                  </div>
                  <div class="result-detail-card">
                    <h4>زمان صرف شده</h4>
                    <p id="time-spent">00:00:00</p>
                  </div>
                  <div class="result-detail-card">
                    <h4>درصد پاسخ‌ها</h4>
                    <p id="answer-percentage">0%</p>
                  </div>
                </div>
              </div>

              <!-- فیلد پاسخ دانش‌آموز (مخفی شده) -->
              <div class="input-group" style="display: none">
                <label for="student-answers">پاسخ‌های شما:</label>
                <div class="copy-btn" onclick="copyStudentAnswers()">
                  <i class="fas fa-copy"></i>
                </div>
                <textarea
                  id="student-answers"
                  placeholder="برای دریافت کارنامه، پاسخ خود را کپی کرده و وارد برگه‌یار شوید"
                  readonly
                ></textarea>
              </div>

              <!-- دکمه کپی پاسخ (مخفی شده) -->
              <!-- در صفحه result-page -->
              <div class="form-actions">
                <button
                  class="btn btn-primary"
                  onclick="copyStudentAnswers()"
                  style="display: none"
                >
                  <i class="fas fa-copy"></i> کپی کردن پاسخ
                </button>
                <button class="btn btn-success" onclick="goToAnswerSheet()">
                  <i class="fas fa-external-link-alt"></i>انتقال به برگه یار و
                  نمایش کارنامه
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="showPage('manual-exam')"
                >
                  <i class="fas fa-arrow-right"></i> بازگشت به صفحه اصلی
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>
          ساخته شده با ❤️ | پشتیبانی: support.azmoonyar@gmail.com | نسخه ۴.۰.۰
        </p>
      </div>
    </div>

    <!-- مودال پایان آزمون -->
    <div class="modal" id="finishModal">
      <div class="modal-content">
        <h3>آیا از پایان آزمون مطمئن هستید؟</h3>
        <p>با تایید، آزمون به پایان خواهد رسید و پاسخ‌های شما ثبت می‌شود.</p>
        <div class="modal-buttons">
          <button class="btn btn-primary" onclick="finishExam()">
            بله، پایان آزمون
          </button>
          <button class="btn btn-secondary" onclick="closeModal('finishModal')">
            خیر، ادامه آزمون
          </button>
        </div>
      </div>
    </div>

    <!-- مودال زمان پایان یافته -->
    <div class="modal" id="timeoutModal">
      <div class="modal-content">
        <h3>زمان شما به پایان رسید</h3>
        <p>آیا می‌خواهید آزمون را ادامه دهید یا به پایان برسانید?</p>
        <div class="modal-buttons">
          <button class="btn btn-primary" onclick="continueExam()">
            ادامه آزمون
          </button>
          <button class="btn btn-secondary" onclick="finishExam()">
            پایان آزمون
          </button>
        </div>
      </div>
    </div>

    <script>
      // تغییر تم
      document.querySelectorAll(".theme-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const theme = this.getAttribute("data-theme");

          // حذف کلاس active از تمام دکمه‌ها
          document.querySelectorAll(".theme-btn").forEach((b) => {
            b.classList.remove("active");
          });

          // اضافه کردن کلاس active به دکمه انتخاب شده
          this.classList.add("active");

          // اعمال تم انتخاب شده
          document.body.setAttribute("data-theme", theme);

          // ذخیره تم در localStorage
          localStorage.setItem("selectedTheme", theme);
        });
      });

      // بارگذاری تم ذخیره شده
      window.addEventListener("DOMContentLoaded", function () {
        const savedTheme = localStorage.getItem("selectedTheme") || "ocean";
        document.body.setAttribute("data-theme", savedTheme);

        // فعال کردن دکمه تم ذخیره شده
        document
          .querySelectorAll(`.theme-btn[data-theme="${savedTheme}"]`)
          .forEach((btn) => {
            btn.classList.add("active");
          });
      });

      // پرامپت‌ها
      const prompts = {
        json: `فایل PDF یا تصویر پیوست‌شده حاوی سوالات آزمون است. لطفاً فقط صفحات دارای سوالات شماره‌گذاری‌شده (مانند ۱، ۲، ۳، ۴، ۵، ۶، ۷، ۸، ۹، ۱۰ و غیره با استفاده از اعداد فارسی) را پردازش کن و صفحات بدون شماره سوال (مانند صفحه کاور، صفحات حاوی اطلاعات آزمون، صفحات خالی، پاسخ‌برگ‌ها، یا هر صفحه‌ای که فاقد ستون عمودی شماره سوالات است) را کاملاً نادیده بگیر. شماره سوالات همیشه به صورت اعداد فارسی (۱، ۲، ۳...) در یک ستون عمودی در سمت راست‌ترین قسمت صفحه (یعنی راست‌ترین ستون اعداد، معمولاً نزدیک حاشیه راست صفحه) قرار دارند. این ستون معمولاً شامل شماره‌های متوالی است و ممکن است با خطوط افقی یا عمودی جدا شده باشد.

برای دستیابی به بیشترین دقت در برش، از ابزارهای تحلیل تصویر پیشرفته استفاده کن. مرزهای هر سوال را با دقت پیکسلی شناسایی کن: y1 را دقیقاً از پیکسل شروع بالاترین عنصر و y2 را دقیقاً تا پیکسل پایان پایین‌ترین عنصر تنظیم کن، بدون هیچ هم‌پوشانی یا فاصله اضافی.

فرض کن DPI = ۶۰۰ برای تبدیل PDF به تصویر، و عرض صفحه دقیقاً ۳۶۰۰ پیکسل است.

خروجی باید فقط JSON باشد با فرمت دقیق زیر:

{
  "صفحه_X": [
    { "شماره": "N", "x1": 0, "y1": Y1, "x2": 3600, "y2": Y2 }
  ]
}

که در آن:
- X شماره صفحه واقعی در PDF است
- N شماره سوال است (به صورت رشته با اعداد فارسی)
- Y1 و Y2 مختصات عمودی بر حسب پیکسل هستند

لطفاً فقط کد JSON خالص بدون هیچ متن اضافی تولید کن.`,

        key: `۲. پردازش پاسخنامه تشریحی (کلید آزمون):
            - پاسخ‌های صحیح را از پاسخنامه استخراج کن
            - اطلاعات زیر را تشخیص بده:
              * تعداد سوالات واقعی
              * نام هر درس
              * نوع درس (فقط "عمومی" یا "تخصصی")
              * بازه سوالات هر درس
              * مباحث درسی (برای دروس تخصصی)
            در نهایت اول کلید و بعد اطلاعات را با یک خط فاصله به کاربر میدی در اطلاعات هم هر چیزی که هست چه درس چه تاریخ با یک خط فاصله ارسال میشود
            فرمت خروجی دقیق:
            [پاسخ‌های صحیح]total_questions:[عدد]|subject:[نام درس]|type:[نوع]|start:[شروع]|end:[پایان]|chapters:[مباحث]

            مثال خروجی:
            1234213421...total_questions:250|subject:زبان|type:عمومی|start:1|end:30|subject:ریاضی|type:تخصصی|start:31|end:120|chapters:1,2,3

            ---

            قوانین سخت‌گیرانه:
            ✅ فقط داده‌های خام برگردان
            ✅ هیچ متن اضافی ننویس
            ✅ از فرمت دقیقاً پیروی کن
            ✅ فقط اعداد انگلیسی استفاده کن
            ✅ فیلدها با | جدا شوند
            ✅ نوع درس فقط "عمومی" یا "تخصصی" است
            ✅ chapters فقط برای دروس تخصصی
            ✅ طول رشته پاسخ‌ها = تعداد سوالات
            هر کدوم از کد ها رو جداجدا میفرستی و طوری باشه دانش اموز با کلیک روی ان کپی کن`,
      };

      // اطلاعات آزمون
      let examData = {
        questions: [],
        totalQuestions: 0,
        optionsCount: 4,
        timerInterval: null,
        timeRemaining: 7200, // 120 دقیقه به ثانیه
        examName: "آزمون دستی",
        answers: {},
        currentPage: 1,
        questionsPerPage: 10,
        examStarted: false,
        timerHidden: false,
      };

      // انتخاب کارت تعداد گزینه‌ها
      function selectOptionCard(card) {
        document.querySelectorAll(".option-card").forEach((c) => {
          c.classList.remove("selected");
        });

        card.classList.add("selected");
        examData.optionsCount = parseInt(card.getAttribute("data-options"));
      }

      // آپلود فایل
      function handleFileUpload(input) {
        if (input.files && input.files[0]) {
          const fileName = input.files[0].name;
          examData.examName = fileName;

          // نمایش پیش‌نمایش برای تصاویر
          if (input.files[0].type.includes("image")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const preview = document.getElementById("upload-preview");
              preview.src = e.target.result;
              preview.style.display = "block";
            };
            reader.readAsDataURL(input.files[0]);
          }

          showNotification(`فایل "${fileName}" با موفقیت آپلود شد`);
        }
      }

      // کپی پرامپت
      function copyPrompt(type) {
        navigator.clipboard
          .writeText(prompts[type])
          .then(() => {
            showNotification("پرامپت با موفقیت کپی شد!");
          })
          .catch((err) => {
            showNotification("خطا در کپی پرامپت: " + err.message);
          });
      }

      // تابع اصلاح شده برای پردازش JSON
      function cleanAndParseJSON(jsonString) {
        try {
          console.log("JSON خام ورودی:", jsonString);

          // اگر JSON قبلاً پارس شده باشد، آن را برگردان
          if (typeof jsonString === "object") {
            return jsonString;
          }

          // حذف کاراکترهای غیر ضروری از ابتدا و انتها
          let cleanedJSON = jsonString
            .replace(/^[^{[]*([{[])/, "$1") // حذف همه چیز قبل از اولین { یا [
            .replace(/([}\]])[^}\]]*$/, "$1") // حذف همه چیز بعد از آخرین } یا ]
            .trim();

          console.log("JSON پس از پاکسازی:", cleanedJSON);

          // بررسی اینکه آیا JSON معتبر است
          if (!cleanedJSON.startsWith("{") && !cleanedJSON.startsWith("[")) {
            throw new Error("فرمت JSON نامعتبر است");
          }

          return JSON.parse(cleanedJSON);
        } catch (error) {
          console.error("خطای نهایی در پردازش JSON:", error);
          throw new Error(
            `خطا در پردازش JSON: ${error.message}. لطفاً مطمئن شوید که فقط کد JSON خالص را وارد کرده‌اید.`
          );
        }
      }

      // تابع detectAndScaleCoordinates را با این نسخه جایگزین کنید
      function detectAndScaleCoordinates(jsonData) {
        let maxXValue = 0;
        let has7200Format = false;

        // بررسی همه مقادیر x2 برای تشخیص فرمت
        for (const page in jsonData) {
          for (const question of jsonData[page]) {
            maxXValue = Math.max(maxXValue, question.x2 || 0);
            if (question.x2 === 7200) {
              has7200Format = true;
              break;
            }
          }
          if (has7200Format) break;
        }

        console.log("بیشترین مقدار X یافت شده:", maxXValue);
        console.log("فرمت 7200 پیکسلی تشخیص داده شد:", has7200Format);

        // اگر فرمت 7200 تشخیص داده شد، مقیاس‌گذاری کن
        if (has7200Format) {
          console.log("تشخیص داده شد: فرمت مختصات 7200 پیکسلی");
          return scaleCoordinates(jsonData, 3600, 7200);
        }

        // اگر فرمت 3600 است، تغییر نده
        if (maxXValue === 3600) {
          console.log("تشخیص داده شد: فرمت مختصات 3600 پیکسلی");
          return jsonData;
        }

        console.warn(
          "فرمت مختصات ناشناخته. استفاده از مقیاس پیش‌فرض 3600 پیکسل."
        );
        // برای ایمنی، فرض می‌کنیم فرمت 7200 است و مقیاس‌گذاری می‌کنیم
        return scaleCoordinates(jsonData, 3600, 7200);
      }

      // بهبود تابع scaleCoordinates برای پشتیبانی از هر دو فرمت
      function scaleCoordinates(
        jsonData,
        targetWidth = 3600,
        originalWidth = 7200
      ) {
        // اگر عرض اصلی همان عرض هدف است، نیازی به مقیاس‌گذاری نیست
        if (originalWidth === targetWidth) {
          return jsonData;
        }

        const scaleFactor = targetWidth / originalWidth;
        const scaledData = {};

        console.log(
          `مقیاس‌گذاری مختصات از ${originalWidth} به ${targetWidth} (ضریب: ${scaleFactor})`
        );

        for (let page in jsonData) {
          scaledData[page] = jsonData[page].map((question) => {
            const scaledQuestion = {
              ...question,
              x1: Math.round(question.x1 * scaleFactor),
              x2: Math.round(question.x2 * scaleFactor),
              y1: Math.round(question.y1 * scaleFactor),
              y2: Math.round(question.y2 * scaleFactor),
            };

            console.log(
              `سوال ${question.شماره}: (${question.x1},${question.y1})-(${question.x2},${question.y2}) → (${scaledQuestion.x1},${scaledQuestion.y1})-(${scaledQuestion.x2},${scaledQuestion.y2})`
            );

            return scaledQuestion;
          });
        }

        return scaledData;
      }

      // تابع createExam را با این نسخه جایگزین کنید
      async function createExam(processAllPages = false) {
        const jsonCode = document.getElementById("json-code").value.trim();
        console.log("JSON ورودی:", jsonCode);
        const fileInput = document.getElementById("file-upload");
        const pdfFile = fileInput.files[0];

        if (!jsonCode) {
          showNotification("لطفاً کد JSON را وارد کنید.", "error");
          return;
        }

        if (!pdfFile) {
          showNotification("لطفاً فایل PDF سوالات را آپلود کنید.", "error");
          return;
        }

        try {
          // پردازش و پاکسازی JSON
          const jsonData = cleanAndParseJSON(jsonCode);

          // تشخیص و مقیاس‌بندی خودکار مختصات
          const scaledData = detectAndScaleCoordinates(jsonData);

          // اعتبارسنجی مختصات
          const validatedData = validateCoordinates(scaledData);

          // پردازش سوالات از JSON
          const questions = await processQuestionsFromJSON(
            validatedData,
            pdfFile,
            processAllPages
          );

          examData.totalQuestions = questions.length;
          examData.timeRemaining =
            parseInt(document.getElementById("timer-input").value) * 60;
          examData.questions = questions;
          examData.answers = {};
          examData.currentPage = 1;
          examData.examStarted = false;

          // نمایش نام آزمون
          document.getElementById("exam-name").textContent = examData.examName;

          // نمایش سوالات
          displayQuestions();

          // ایجاد نوار وضعیت
          createProgressBar();

          // ایجاد صفحه‌بندی
          createPagination();

          // رفتن به صفحه آزمون
          showPage("manual-exam-page");

          showNotification(
            `آزمون با ${examData.totalQuestions} سوال ایجاد شد!` +
              (processAllPages ? "" : " (۱۰ سوال اول نمایش داده می‌شوند)"),
            "success"
          );

          // اگر همه صفحات پردازش نشده‌اند، پس‌زمینه بقیه را پردازش کن
          if (!processAllPages) {
            processRemainingPagesInBackground(jsonData, pdfFile);
          }
        } catch (error) {
          showNotification("خطا در پردازش: " + error.message, "error");
        }
      }

      // تابع جدید برای پردازش پس‌زمینه صفحات باقیمانده
      async function processRemainingPagesInBackground(jsonData, pdfFile) {
        try {
          console.log("پردازش پس‌زمینه صفحات باقیمانده آغاز شد");

          // پردازش همه صفحات
          const allQuestions = await processQuestionsFromJSON(
            jsonData,
            pdfFile,
            true // processAllPages = true
          );

          // به روزرسانی داده‌های آزمون با سوالات کامل
          examData.questions = allQuestions;
          examData.totalQuestions = allQuestions.length;

          console.log("پردازش پس‌زمینه صفحات با موفقیت انجام شد");
          showNotification("همه سوالات در پس‌زمینه پردازش شدند", "info");
        } catch (error) {
          console.error("خطا در پردازش پس‌زمینه:", error);
        }
      }

      // ایجاد نوار وضعیت سوالات
      function createProgressBar() {
        const progressBar = document.getElementById("progress-bar");
        progressBar.innerHTML = "";

        const startQuestion =
          (examData.currentPage - 1) * examData.questionsPerPage + 1;
        const endQuestion = Math.min(
          startQuestion + examData.questionsPerPage - 1,
          examData.totalQuestions
        );

        for (let i = startQuestion; i <= endQuestion; i++) {
          const progressItem = document.createElement("div");
          progressItem.className = "progress-item";
          progressItem.textContent = i;
          progressItem.onclick = () => scrollToQuestion(i);

          if (i === startQuestion) {
            progressItem.classList.add("current");
          }

          if (examData.answers[i]) {
            progressItem.classList.add("answered");
          }

          progressBar.appendChild(progressItem);
        }
      }

      // پیمایش به سوال خاص
      function scrollToQuestion(questionNumber) {
        const questionElement = document.getElementById(
          `question-${questionNumber}`
        );
        if (questionElement) {
          questionElement.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });

          // هایلایت سوال در نوار وضعیت
          document.querySelectorAll(".progress-item").forEach((item) => {
            item.classList.remove("current");
            if (parseInt(item.textContent) === questionNumber) {
              item.classList.add("current");
            }
          });
        }
      }

      // شروع آزمون
      function startExam() {
        examData.examStarted = true;
        document.getElementById("start-exam-btn").style.display = "none";
        startTimer();
        showNotification("آزمون شروع شد! زمان در حال محاسبه است.");
      }

      // شروع تایمر آزمون
      function startTimer() {
        // اگر تایمر در حال اجراست، متوقفش کن
        if (examData.timerInterval) {
          clearInterval(examData.timerInterval);
        }

        const timerElement = document.getElementById("exam-timer");

        examData.timerInterval = setInterval(() => {
          examData.timeRemaining--;

          if (examData.timeRemaining <= 0) {
            clearInterval(examData.timerInterval);
            showTimeoutModal();
            return;
          }

          // به روزرسانی نمایش تایمر
          const hours = Math.floor(examData.timeRemaining / 3600);
          const minutes = Math.floor((examData.timeRemaining % 3600) / 60);
          const seconds = examData.timeRemaining % 60;

          timerElement.textContent = `${hours
            .toString()
            .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
        }, 1000);
      }

      // مخفی/نمایش تایمر
      function toggleTimerVisibility() {
        examData.timerHidden = !examData.timerHidden;
        const timer = document.getElementById("exam-timer");
        const hideBtn = document.getElementById("hide-timer-btn");

        if (examData.timerHidden) {
          timer.classList.add("hidden");
          hideBtn.innerHTML = '<i class="fas fa-eye"></i>';
        } else {
          timer.classList.remove("hidden");
          hideBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        }
      }

      // نمایش سوالات در صفحه آزمون
      function displayQuestions() {
        const container = document.getElementById("questions-container");
        container.innerHTML = "";

        const startIndex =
          (examData.currentPage - 1) * examData.questionsPerPage;
        const endIndex = Math.min(
          startIndex + examData.questionsPerPage,
          examData.totalQuestions
        );

        for (let i = startIndex; i < endIndex; i++) {
          const question = examData.questions[i];

          // ایجاد کارت سوال به سبک DigitalYar
          const questionCard = document.createElement("div");
          questionCard.className = "question-card";
          questionCard.id = `question-${question.number}`;

          if (
            examData.currentFilter === "not-answered" &&
            examData.answers[question.number]
          ) {
            questionCard.classList.add("filtered");
          }

          const optionLetters = ["۱", "۲", "۳", "۴", "۵"];
          let optionsHTML = "";

          for (let j = 0; j < examData.optionsCount; j++) {
            optionsHTML += `
                            <div class="option-item" onclick="selectOptionForQuestion(${
                              question.number
                            }, ${j + 1})">
                                <div class="option-marker">${
                                  optionLetters[j]
                                }</div>
                            </div>
                        `;
          }

          questionCard.innerHTML = `
          <div class="question-number">سوال ${question.number}</div>
          <div style="position: relative;">
              <img src="${question.image}" class="question-image" alt="سوال ${question.number}" onclick="zoomQuestionImage('${question.image}')">
              <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="zoomQuestionImage('${question.image}')">
                  <i class="fas fa-search-plus"></i>
              </div>
          </div>
          <div class="options-container">
              ${optionsHTML}
          </div>
      `;

          container.appendChild(questionCard);

          // اگر پاسخ قبلی وجود دارد، آن را نمایش بده
          if (examData.answers[question.number]) {
            updateQuestionDisplay(
              question.number,
              examData.answers[question.number]
            );
          }
        }
      }

      // تغییر تابع selectOptionForQuestion
      function selectOptionForQuestion(questionNumber, optionNumber) {
        if (!examData.examStarted) {
          showNotification(
            "لطفاً ابتدا آزمون را شروع کنید! روی دکمه 'شروع آزمون' کلیک کنید.",
            "error"
          );
          return;
        }

        // اگر گزینه قبلاً انتخاب شده بود، آن را حذف کن
        if (examData.answers[questionNumber] === optionNumber) {
          examData.answers[questionNumber] = null;
          showNotification(`پاسخ سوال ${questionNumber} حذف شد`, "info");
        } else {
          // در غیر این صورت، گزینه جدید را انتخاب کن
          examData.answers[questionNumber] = optionNumber;
          showNotification(`پاسخ سوال ${questionNumber} ثبت شد`, "success");
        }

        // به روزرسانی نمایش
        updateQuestionDisplay(questionNumber, examData.answers[questionNumber]);

        // به روزرسانی نوار وضعیت
        updateProgressBar();
      }

      // ذخیره پاسخ
      examData.answers[questionNumber] = optionNumber;

      // به روزرسانی نمایش
      updateQuestionDisplay(questionNumber, optionNumber);

      // به روزرسانی نوار وضعیت
      updateProgressBar();

      showNotification(`پاسخ سوال ${questionNumber} ثبت شد`, "success");

      // به روزرسانی نمایش سوال
      function updateQuestionDisplay(questionNumber, optionNumber) {
        const questionCard = document.getElementById(
          `question-${questionNumber}`
        );
        if (!questionCard) return;

        // به روزرسانی ظاهر گزینه‌ها
        questionCard.querySelectorAll(".option-item").forEach((item, index) => {
          item.classList.remove("selected");
          if (index + 1 === optionNumber) {
            item.classList.add("selected");
          }
        });
      }

      // به روزرسانی نوار وضعیت
      function updateProgressBar() {
        document.querySelectorAll(".progress-item").forEach((item) => {
          const questionNumber = parseInt(item.textContent);
          if (examData.answers[questionNumber]) {
            item.classList.add("answered");
          } else {
            item.classList.remove("answered");
          }
        });
      }

      // ایجاد صفحه‌بندی
      function createPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const totalPages = Math.ceil(
          examData.totalQuestions / examData.questionsPerPage
        );

        if (totalPages > 1) {
          // دکمه قبلی
          if (examData.currentPage > 1) {
            const prevBtn = document.createElement("button");
            prevBtn.className = "page-btn";
            prevBtn.innerHTML = '<i class="fas fa-arrow-right"></i> قبلی';
            prevBtn.onclick = () => changePage(examData.currentPage - 1);
            pagination.appendChild(prevBtn);
          }

          // دکمه‌های صفحات
          for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.className = "page-btn";
            if (i === examData.currentPage) {
              pageBtn.classList.add("active");
            }
            pageBtn.textContent = i;
            pageBtn.onclick = () => changePage(i);
            pagination.appendChild(pageBtn);
          }

          // دکمه بعدی
          if (examData.currentPage < totalPages) {
            const nextBtn = document.createElement("button");
            nextBtn.className = "page-btn";
            nextBtn.innerHTML = 'بعدی <i class="fas fa-arrow-left"></i>';
            nextBtn.onclick = () => changePage(examData.currentPage + 1);
            pagination.appendChild(nextBtn);
          }
        }
      }

      // تغییر صفحه
      function changePage(pageNumber) {
        examData.currentPage = pageNumber;
        displayQuestions();
        createProgressBar();
        createPagination();

        // اسکرول به بالای صفحه
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // فیلتر کردن سوالات
      function filterQuestions(filter) {
        examData.currentFilter = filter;

        // فعال کردن دکمه فیلتر انتخاب شده
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // اعمال فیلتر
        const questions = document.querySelectorAll(".question-card");
        questions.forEach((card) => {
          const questionNumber = parseInt(card.id.replace("question-", ""));

          card.style.display = "block";

          if (filter === "not-answered" && examData.answers[questionNumber]) {
            card.style.display = "none";
          } else if (
            filter === "answered" &&
            !examData.answers[questionNumber]
          ) {
            card.style.display = "none";
          }
        });
      }

      // نمایش مودال زمان پایان یافته
      function showTimeoutModal() {
        document.getElementById("timeoutModal").classList.add("active");
      }

      // ادامه آزمون پس از اتمام زمان
      function continueExam() {
        closeModal("timeoutModal");
        // تایمر را صفر نگه دار ولی اجازه ادامه آزمون بده
        examData.timeRemaining = 0;
        document.getElementById("exam-timer").textContent = "00:00:00";
      }

      // تایید پایان آزمون
      function confirmFinishExam() {
        document.getElementById("finishModal").classList.add("active");
      }

      // پایان آزمون
      function finishExam() {
        closeModal("finishModal");
        closeModal("timeoutModal");

        if (examData.timerInterval) {
          clearInterval(examData.timerInterval);
          examData.timerInterval = null;
        }

        // تولید کد پاسخ
        let answerCode = "";
        for (let i = 1; i <= examData.totalQuestions; i++) {
          answerCode += examData.answers[i] || "0";
        }

        // ذخیره پاسخ‌ها
        localStorage.setItem("studentAnswers", answerCode);

        // نمایش پاسخ‌های دانش‌آموز در فیلد مربوطه (مخفی شده)
        document.getElementById("student-answers").value = ""; // پاک کردن محتوا

        // به‌روزرسانی آمار آزمون
        updateExamStats();

        showNotification(
          "آزمون با موفقیت به پایان رسید! پاسخ‌های شما ذخیره شد.",
          "success"
        );

        // رفتن به صفحه نتایج
        setTimeout(() => {
          showPage("result-page");
        }, 1000);
      }

      // نمایش کارنامه
      function showReport() {
        const examKeyCode = document
          .getElementById("exam-key-code")
          .value.trim();

        if (!examKeyCode) {
          showNotification("لطفاً کلید آزمون را وارد کنید.", "error");
          return;
        }

        showNotification("کارنامه شما در حال محاسبه است...", "success");
        // در اینجا می‌توانید پردازش کارنامه را اضافه کنید
      }

      // بستن مودال
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
      }

      // نمایش صفحه
      function showPage(pageId) {
        document.querySelectorAll(".page").forEach((page) => {
          page.classList.remove("active");
        });
        document.getElementById(pageId).classList.add("active");
      }

      // بازگشت به صفحه قبل
      function goBack() {
        showNotification("در حال بازگشت...");
        // در اینجا می‌توانید به صفحه قبل هدایت کنید
      }

      // نمایش نوتیفیکیشن
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
                            <i class="fas fa-${
                              type === "error"
                                ? "exclamation-circle"
                                : type === "success"
                                ? "check-circle"
                                : "info-circle"
                            }"></i>
                            <span>${message}</span>
                        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 100);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 500);
        }, 3000);
      }

      // اضافه کردن این متغیرهای global در ابتدای بخش script
      var pdfImages = {};
      var pdfDocument = null;

      // تابع برای بارگذاری PDF
      async function loadPDF(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function (e) {
            try {
              const typedArray = new Uint8Array(e.target.result);
              pdfDocument = await pdfjsLib.getDocument(typedArray).promise;
              resolve(pdfDocument);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      // تغییر از scale = 2 به scale = 5
      async function renderPDFPage(pageNumber, scale = 5) {
        if (!pdfDocument) {
          throw new Error("PDF بارگذاری نشده است");
        }

        const page = await pdfDocument.getPage(pageNumber);
        const viewport = page.getViewport({ scale }); // scale افزایش یافته

        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({
          canvasContext: context,
          viewport: viewport,
        }).promise;

        return canvas.toDataURL("image/png");
      }

      // تابع برای تبدیل اعداد عربی به فارسی
      function convertArabicToPersianNumbers(str) {
        const arabicNumbers = [
          "۰",
          "۱",
          "۲",
          "۳",
          "۴",
          "۵",
          "۶",
          "۷",
          "۸",
          "۹",
        ];
        const persianNumbers = [
          "۰",
          "۱",
          "۲",
          "۳",
          "۴",
          "۵",
          "۶",
          "۷",
          "۸",
          "۹",
        ];

        return str.replace(
          /[۰-۹]/g,
          (d) => persianNumbers[arabicNumbers.indexOf(d)]
        );
      }

      // تابع برای تبدیل اعداد به انگلیسی
      function convertToEnglishNumbers(str) {
        const persianNumbers = [
          "۰",
          "۱",
          "۲",
          "۳",
          "۴",
          "۵",
          "۶",
          "۷",
          "۸",
          "۹",
        ];
        const arabicNumbers = [
          "۰",
          "۱",
          "۲",
          "۳",
          "۴",
          "۵",
          "۶",
          "۷",
          "۸",
          "۹",
        ];
        const englishNumbers = [
          "0",
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
        ];

        return str.replace(/[۰-۹]/g, (d) => {
          const persianIndex = persianNumbers.indexOf(d);
          if (persianIndex !== -1) return englishNumbers[persianIndex];

          const arabicIndex = arabicNumbers.indexOf(d);
          if (arabicIndex !== -1) return englishNumbers[arabicIndex];

          return d;
        });
      }

      // تابع processQuestionsFromJSON را با این نسخه جایگزین کنید
      async function processQuestionsFromJSON(
        jsonData,
        pdfFile,
        processAllPages = false
      ) {
        try {
          console.log("داده‌های JSON دریافتی:", jsonData);

          // مقداردهی اولیه pdfImages اگر تعریف نشده
          if (typeof pdfImages === "undefined") {
            pdfImages = {};
          }

          // بارگذاری PDF اگر فایل ارائه شده
          if (pdfFile && !pdfDocument) {
            await loadPDF(pdfFile);
          }

          const questions = [];
          let questionNumber = 1;

          // پردازش هر صفحه از JSON
          const pageKeys = Object.keys(jsonData);

          // اگر processAllPages false باشد، فقط 10 سوال اول را پردازش کن
          const maxPagesToProcess = processAllPages ? pageKeys.length : 1;

          for (let p = 0; p < maxPagesToProcess; p++) {
            const pageKey = pageKeys[p];
            const pageQuestions = jsonData[pageKey];

            console.log(`پردازش صفحه: ${pageKey}`, pageQuestions);

            // استخراج شماره صفحه از کلید
            let pageNum;
            if (pageKey.startsWith("صفحه_")) {
              pageNum = parseInt(
                convertToEnglishNumbers(pageKey.replace("صفحه_", ""))
              );
            } else if (pageKey.startsWith("صفحه")) {
              pageNum = parseInt(
                convertToEnglishNumbers(pageKey.replace("صفحه", ""))
              );
            } else {
              const numbers = pageKey.match(/\d+/);
              pageNum = numbers
                ? parseInt(convertToEnglishNumbers(numbers[0]))
                : 1;
            }

            if (isNaN(pageNum)) {
              console.warn(`شماره صفحه نامعتبر برای کلید: ${pageKey}`);
              pageNum = 1;
            }

            console.log(`شماره صفحه استخراج شده: ${pageNum}`);

            // رندر صفحه PDF (اگر قبلا رندر نشده)
            let pageImage = pdfImages[pageNum];
            if (!pageImage) {
              if (pdfDocument) {
                try {
                  pageImage = await renderPDFPage(pageNum);
                  pdfImages[pageNum] = pageImage;
                } catch (error) {
                  console.error(`خطا در رندر صفحه ${pageNum}:`, error);
                  pageImage = `https://via.placeholder.com/800x1000/1b9aaa/ffffff?text=صفحه+${pageNum}`;
                }
              } else {
                pageImage = `https://via.placeholder.com/800x1000/1b9aaa/ffffff?text=صفحه+${pageNum}`;
              }
            }

            // پردازش هر سوال در صفحه
            for (const questionData of pageQuestions) {
              console.log(`پردازش سوال:`, questionData);

              // تبدیل شماره سوال از عربی/فارسی به انگلیسی
              let actualNumber = parseInt(
                convertToEnglishNumbers(questionData.شماره)
              );
              if (isNaN(actualNumber)) {
                console.warn(`شماره سوال نامعتبر: ${questionData.شماره}`);
                actualNumber = questionNumber;
              }

              let questionImage = null;
              const x1 = questionData.x1 || 0;
              const x2 = questionData.x2 || 3600;
              const y1 = questionData.y1 || 0;
              const y2 = questionData.y2 || 300;

              // برش تصویر سوال
              try {
                if (pageImage.startsWith("data:image")) {
                  questionImage = await cropImage(pageImage, x1, y1, x2, y2);
                } else {
                  // اگر تصویر صفحه placeholder است، از همان استفاده کن
                  questionImage = pageImage;
                }
              } catch (error) {
                console.error(`خطا در برش تصویر سوال ${actualNumber}:`, error);
                questionImage = `https://via.placeholder.com/600x200/1b9aaa/ffffff?text=سوال+${actualNumber}`;
              }

              questions.push({
                number: actualNumber,
                image: questionImage,
                options: examData.optionsCount,
                page: pageNum,
                coordinates: { x1, y1, x2, y2 },
              });

              questionNumber = Math.max(questionNumber, actualNumber) + 1;

              // اگر 10 سوال پردازش شد و processAllPages false است، متوقف شو
              if (!processAllPages && questions.length >= 10) {
                break;
              }
            }

            // اگر 10 سوال پردازش شد و processAllPages false است، متوقف شو
            if (!processAllPages && questions.length >= 10) {
              break;
            }
          }

          if (questions.length === 0) {
            throw new Error("هیچ سوالی از JSON استخراج نشد");
          }

          questions.sort((a, b) => a.number - b.number);
          console.log("سوالات ایجاد شده:", questions);
          return questions;
        } catch (error) {
          console.error("خطا در پردازش سوالات:", error);
          throw error;
        }
      }

      function cropImage(imageSrc, x1, y1, x2, y2) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            // اضافه کردن حاشیه 15 پیکسلی
            const margin = 15;
            const adjustedY1 = Math.max(0, y1 - margin);
            const adjustedY2 = Math.min(img.height, y2 + margin);

            const width = x2 - x1;
            const height = adjustedY2 - adjustedY1;

            canvas.width = width;
            canvas.height = height;

            ctx.drawImage(
              img,
              x1,
              adjustedY1,
              width,
              height,
              0,
              0,
              width,
              height
            );

            resolve(canvas.toDataURL("image/png"));
          };
          img.onerror = reject;
          img.src = imageSrc;
        });
      }

      // زوم تصویر سوال - نسخه بهبود یافته
      function zoomQuestionImage(imageSrc) {
        // غیرفعال کردن اسکرول صفحه
        document.body.classList.add("modal-open");

        // ایجاد مودال زوم
        const zoomModal = document.createElement("div");
        zoomModal.className = "image-zoom-modal active";
        zoomModal.innerHTML = `
      <span class="close-zoom" onclick="closeImageZoom()">&times;</span>
      <div class="zoomed-image-container">
        <img class="zoomed-image" src="${imageSrc}" alt="تصویر سوال">
      </div>
    `;

        // بستن مودال با کلیک روی پس‌زمینه
        zoomModal.onclick = function (e) {
          if (e.target === zoomModal) {
            closeImageZoom();
          }
        };

        document.body.appendChild(zoomModal);

        // جلوگیری از اسکرول هنگام نمایش مودال
        document.addEventListener("wheel", preventScroll, { passive: false });
        document.addEventListener("touchmove", preventScroll, {
          passive: false,
        });
      }

      // بستن زوم تصویر
      function closeImageZoom() {
        const zoomModal = document.querySelector(".image-zoom-modal");
        if (zoomModal) {
          zoomModal.classList.remove("active");
          setTimeout(() => {
            document.body.removeChild(zoomModal);
            document.body.classList.remove("modal-open");

            // حذف event listeners برای جلوگیری از اسکرول
            document.removeEventListener("wheel", preventScroll);
            document.removeEventListener("touchmove", preventScroll);
          }, 300);
        }
      }

      // جلوگیری از اسکرول
      function preventScroll(e) {
        e.preventDefault();
        return false;
      }

      // تولید رشته پاسخ دانش‌آموز
      function generateStudentAnswersString() {
        let answerString = "";

        for (let i = 1; i <= examData.totalQuestions; i++) {
          // اگر پاسخی وجود دارد، آن را اضافه کن، در غیر این صورت 0
          answerString += examData.answers[i] || "0";
        }

        return answerString;
      }

      // کپی پاسخ دانش‌آموز
      function copyStudentAnswers() {
        const studentAnswers = document.getElementById("student-answers").value;

        if (!studentAnswers) {
          showNotification("هیچ پاسخی برای کپی کردن وجود ندارد.", "error");
          return;
        }

        navigator.clipboard
          .writeText(studentAnswers)
          .then(() => {
            showNotification("پاسخ‌های دانش‌آموز با موفقیت کپی شد!");
          })
          .catch((err) => {
            showNotification("خطا در کپی پاسخ‌ها: " + err.message, "error");
          });
      }

      // بارگذاری پاسخ‌های ذخیره شده
      function loadSavedAnswers() {
        const savedAnswers = localStorage.getItem("studentAnswers");

        if (savedAnswers) {
          document.getElementById("student-answers").value = savedAnswers;

          // همچنین پاسخ‌ها را در examData نیز بارگذاری کنید
          for (let i = 0; i < savedAnswers.length; i++) {
            const answer = parseInt(savedAnswers[i]);
            if (answer > 0) {
              examData.answers[i + 1] = answer;
            }
          }
        }
      }

      // تابع برای به‌روزرسانی آمار نتایج
      function updateExamStats() {
        // محاسبه تعداد سوالات پاسخ داده شده
        const answeredCount = Object.values(examData.answers).filter(
          (answer) => answer !== null && answer !== undefined
        ).length;

        // محاسبه تعداد سوالات بی‌پاسخ
        const unansweredCount = examData.totalQuestions - answeredCount;

        // محاسبه زمان صرف شده
        const totalTimeSeconds =
          parseInt(document.getElementById("timer-input").value) * 60 -
          examData.timeRemaining;
        const hours = Math.floor(totalTimeSeconds / 3600);
        const minutes = Math.floor((totalTimeSeconds % 3600) / 60);
        const seconds = totalTimeSeconds % 60;
        const timeSpent = `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

        // محاسبه درصد پاسخ‌ها
        const answerPercentage = Math.round(
          (answeredCount / examData.totalQuestions) * 100
        );

        // به‌روزرسانی عناصر HTML
        document.getElementById("answered-count").textContent = answeredCount;
        document.getElementById("total-questions").textContent =
          examData.totalQuestions;
        document.getElementById("unanswered-count").textContent =
          unansweredCount;
        document.getElementById("time-spent").textContent = timeSpent;
        document.getElementById(
          "answer-percentage"
        ).textContent = `${answerPercentage}%`;
      }

      // تغییر تابع finishExam برای فراخوانی آمار
      function finishExam() {
        closeModal("finishModal");
        closeModal("timeoutModal");

        if (examData.timerInterval) {
          clearInterval(examData.timerInterval);
          examData.timerInterval = null;
        }

        // تولید کد پاسخ
        let answerCode = "";
        for (let i = 1; i <= examData.totalQuestions; i++) {
          answerCode += examData.answers[i] || "0";
        }

        // ذخیره پاسخ‌ها
        localStorage.setItem("studentAnswers", answerCode);

        // نمایش پاسخ‌های دانش‌آموز در فیلد مربوطه
        document.getElementById("student-answers").value = answerCode;

        // به‌روزرسانی آمار آزمون
        updateExamStats();

        showNotification(
          "آزمون با موفقیت به پایان رسید! پاسخ‌های شما ذخیره شد.",
          "success"
        );

        // رفتن به صفحه نتایج
        setTimeout(() => {
          showPage("result-page");
        }, 1000);
      }

      // رفتن به برگه‌یار
      function goToAnswerSheet() {
        // ذخیره اطلاعات برای انتقال به برگه‌یار
        localStorage.setItem("fromDigitalYar", "true");
        localStorage.setItem("studentAnswers", generateStudentAnswersString());
        localStorage.setItem(
          "examTotalQuestions",
          examData.totalQuestions.toString()
        );

        // انتقال به صفحه برگه‌یار
        window.location.href = "bargehyar2.html";
      }

      // اضافه کردن تابع اعتبارسنجی مختصات
      function validateCoordinates(x1, y1, x2, y2, pageHeight) {
        if (x1 !== 0) {
          console.warn("x1 باید همیشه 0 باشد، اما دریافت شد:", x1);
          x1 = 0;
        }

        if (x2 !== 3600) {
          console.warn("x2 باید همیشه 3600 باشد، اما دریافت شد:", x2);
          x2 = 3600;
        }

        if (y1 < 0) y1 = 0;
        if (y2 > pageHeight) y2 = pageHeight;
        if (y2 <= y1) y2 = y1 + 100; // حداقل ارتفاع

        return { x1, y1, x2, y2 };
      }

      // تابع برای پردازش مرحله‌ای صفحات
      async function processPagesInBatches(
        pdfDocument,
        jsonData,
        batchSize = 20
      ) {
        const totalPages = pdfDocument.numPages;
        const results = {};

        for (
          let startPage = 1;
          startPage <= totalPages;
          startPage += batchSize
        ) {
          const endPage = Math.min(startPage + batchSize - 1, totalPages);
          console.log(`پردازش صفحات ${startPage} تا ${endPage}`);

          // پردازش این دسته از صفحات
          const batchResults = await processPageBatch(
            pdfDocument,
            jsonData,
            startPage,
            endPage
          );
          Object.assign(results, batchResults);

          // اگر آخرین دسته نبود، منتظر تأیید برای ادامه باش
          if (endPage < totalPages) {
            await new Promise((resolve) => {
              if (
                confirm(
                  `صفحات ${startPage} تا ${endPage} پردازش شد. ادامه دهیم؟`
                )
              ) {
                resolve();
              }
            });
          }
        }

        return results;
      }

      // تابع جدید برای مقیاس‌بندی مختصات
      function scaleCoordinates(jsonData, targetWidth = 3600) {
        const scaleFactor = targetWidth / 7200;
        const scaledData = {};

        for (let page in jsonData) {
          scaledData[page] = jsonData[page].map((question) => {
            return {
              ...question,
              x1: Math.round(question.x1 * scaleFactor),
              x2: Math.round(question.x2 * scaleFactor),
              y1: Math.round(question.y1 * scaleFactor),
              y2: Math.round(question.y2 * scaleFactor),
            };
          });
        }

        return scaledData;
      }

      // تابع validateCoordinates را با این نسخه جایگزین کنید
      function validateCoordinates(jsonData) {
        const validatedData = {};
        let hasWarning = false;

        for (let page in jsonData) {
          validatedData[page] = jsonData[page].map((question) => {
            let { x1, y1, x2, y2 } = question;

            // اعتبارسنجی و تصحیح مختصات
            if (x1 < 0) x1 = 0;
            if (y1 < 0) y1 = 0;
            if (x2 < x1) {
              console.warn(
                `هشدار: x2 (${x2}) کوچکتر از x1 (${x1}) است برای سوال ${question.شماره} در صفحه ${page}`
              );
              x2 = x1 + 100;
              hasWarning = true;
            }
            if (y2 <= y1) {
              console.warn(
                `هشدار: y2 (${y2}) باید بزرگتر از y1 (${y1}) باشد برای سوال ${question.شماره} در صفحه ${page}`
              );
              y2 = y1 + 100; // حداقل ارتفاع
              hasWarning = true;
            }

            return {
              ...question,
              x1,
              y1,
              x2,
              y2,
            };
          });
        }

        if (hasWarning) {
          showNotification(
            "هشدار: برخی مختصات نیاز به تنظیم داشتند. لطفاً نتایج را بررسی کنید.",
            "warning"
          );
        }

        return validatedData;
      }

      // تابع برای پردازش مرحله‌ای صفحات
      async function processPagesInBatches(
        pdfDocument,
        jsonData,
        batchSize = 20
      ) {
        const totalPages = pdfDocument.numPages;
        const results = {};

        for (
          let startPage = 1;
          startPage <= totalPages;
          startPage += batchSize
        ) {
          const endPage = Math.min(startPage + batchSize - 1, totalPages);
          console.log(`پردازش صفحات ${startPage} تا ${endPage}`);

          // پردازش این دسته از صفحات
          const batchResults = await processPageBatch(
            pdfDocument,
            jsonData,
            startPage,
            endPage
          );
          Object.assign(results, batchResults);

          // اگر آخرین دسته نبود، منتظر تأیید برای ادامه باش
          if (endPage < totalPages) {
            await new Promise((resolve) => {
              if (
                confirm(
                  `صفحات ${startPage} تا ${endPage} پردازش شد. ادامه دهیم؟`
                )
              ) {
                resolve();
              }
            });
          }
        }

        return results;
      }

      // تابع انتقال به برگه‌یار
      function goToAnswerSheet() {
        // تولید کد پاسخ
        let answerCode = "";
        for (let i = 1; i <= examData.totalQuestions; i++) {
          answerCode += examData.answers[i] || "0";
        }

        // ذخیره اطلاعات برای انتقال به برگه‌یار
        localStorage.setItem("fromDigitalYar", "true");
        localStorage.setItem("studentAnswers", answerCode);
        localStorage.setItem(
          "examTotalQuestions",
          examData.totalQuestions.toString()
        );

        // انتقال به صفحه برگه‌یار
        window.location.href = "bargehyar2.html";
      }
    </script>
  </body>
</html>
